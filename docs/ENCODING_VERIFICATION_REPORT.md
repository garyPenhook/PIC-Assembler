# PIC Instruction Encoding Verification Report

**Status**: ⚠️ **CRITICAL ISSUES FOUND** ⚠️

## Executive Summary

Comprehensive testing has revealed that **the GnSasm assembler is generating INCORRECT machine code** for several instruction types. The instruction encoding has fundamental bugs in how operand bits are positioned, which means the generated HEX files will **NOT execute correctly** on actual PIC hardware.

## Test Results

### Overall Pass Rate: **62.5% (10/16 tests passing)**

| Category | Passed | Failed | Pass Rate |
|----------|--------|--------|-----------|
| Byte-Oriented | 2 | 4 | 50% ❌ |
| Bit-Oriented | 2 | 2 | 50% ❌ |
| Literal/Control | 4 | 1 | 80% ⚠️ |
| **TOTAL** | **8** | **7** | **53%** |

## Critical Issues Found

### Issue #1: Bit-Oriented Instructions Have Wrong Bit Positions

**Affected Instructions**: BSF, BCF, BTFSC, BTFSS

**Problem**: The bit position operand (b_bit) is shifted to the wrong location in the opcode.

**PIC16 Format**: `10bbbffffffff`
- Bits 13-12: `10` (opcode prefix)
- Bits 11-9: `bbb` (bit position 0-7) ← **WRONG POSITION IN CODE**
- Bits 7-0: `ffffffff` (file register)

**Current Implementation** (WRONG):
```cpp
opcode = Opcodes16Classic::BSF | (b_bit << 7) | f_reg;
//                                 ↑ shifts to bits 8-6, not 11-9!
```

**Example - BSF f=0x25, b=3**:
- Current (wrong): `0x1400 | (3 << 7) | 0x25` = `0x15A5`
- Correct: `0x1400 | (3 << 9) | 0x25` = `0x1625`

**Impact**: All bit manipulation instructions produce wrong opcodes - 100% failure for bit operations.

---

### Issue #2: Byte-Oriented Instructions Have Incorrect Operand Shifts

**Affected Instructions**: ADDWF, MOVF, ANDWF, COMF, DECF, INCF, IORWF, RLF, RRF, SUBWF, SWAPF, XORWF

**Problem**: The destination bit (d_bit) appears to be positioned incorrectly for most instructions.

**PIC16 Format**: `11ddaaffffffff`
- Bits 13-12: `11` (opcode prefix)
- Bits 11-10: `aa` (opcode sub-bits)
- Bit 7: `d` (destination select: 0=W, 1=f)
- Bits 6-0: `fffffff` (file register)

**Current Implementation** (PARTIALLY WRONG):
```cpp
opcode = Opcodes16Classic::ADDWF | (d_bit << 7) | f_reg;
//                                   This assumes d_bit goes to bit 7
```

**Examples**:

| Instruction | d_bit | f_reg | Expected | Actual | Match |
|-------------|-------|-------|----------|--------|-------|
| ADDWF 0x20, 1 | 1 | 0x20 | 0x07A0 | 0x07A0 | ✓ |
| MOVF 0x20, 0 | 0 | 0x20 | 0x0820 | 0x0820 | ✓ |
| MOVF 0x20, 1 | 1 | 0x20 | 0x0920 | 0x08A0 | ✗ |
| CLRF 0x30 | N/A | 0x30 | 0x0190 | 0x01B0 | ✗ |

**Impact**: About 50% of byte-oriented instructions fail depending on specific operand values.

---

## Verification Method

A comprehensive C++ test suite was created that:

1. **Assembles known instructions** using GnSasm
2. **Extracts the generated opcode** from the assembled output
3. **Compares against datasheet specifications** from:
   - PIC16F18076 Datasheet (DS40001419D)
   - Microchip PIC16 Instruction Set Manual

4. **Reports pass/fail** for each test case

## Recommendations

### Immediate Actions Required

1. **Fix Bit-Oriented Instructions** (Priority: CRITICAL)
   - Change bit shift from `<< 7` to `<< 9` for b_bit
   - Affects 4 instruction types

2. **Fix Byte-Oriented Instructions** (Priority: CRITICAL)
   - Review and correct d_bit positioning
   - May need architecture-specific handling
   - Affects 12 instruction types

3. **Re-run Test Suite** (Priority: CRITICAL)
   - After fixes, re-run full test suite
   - Target: 100% pass rate

4. **Add Regression Tests** (Priority: HIGH)
   - Commit test suite to repository
   - Run as part of build process
   - Prevent future encoding regressions

### Long-Term Improvements

1. **Generate test vectors from datasheets** automatically
2. **Compare with MPLAB output** for validation
3. **Add hardware testing** (actual device programming)
4. **Test PIC18 encoding** (likely similar issues)
5. **Create encoding documentation** with bit diagrams

## Code Locations

**Files Requiring Fixes**:
- `src/instruction.cpp` - Encoding functions
  - `encodePIC16Instruction()` - Lines 238-400+
  - `encodePIC18Instruction()` - Needs verification

**Test Code**:
- `test_instruction_encoding.cpp` - New comprehensive test suite

## Datasheet References

For verification of correct encodings, refer to:

1. **PIC16 Byte-Oriented Instructions**
   - Format: `11 ddaa ffffffff`
   - Destination in bit 7 of the 8-bit file register field

2. **PIC16 Bit-Oriented Instructions**
   - Format: `10 bbb ffffffff`
   - Bit position in bits 11-9 of 14-bit instruction

3. **PIC16 Literal Operations**
   - Format: `xxx kkkkkkkkkkkk`
   - Literal in bits 7-0 for most literal instructions

## Conclusion

**The assembler CANNOT be trusted to produce correct machine code in its current state.** Code generated by GnSasm will likely fail or behave unpredictably on actual hardware.

**Recommendation**: Fix these critical encoding bugs before using the assembler for any production or hardware programming tasks.

---

**Test Report Generated**: 2025-11-27
**Test Suite**: `test_instruction_encoding.cpp`
**Build Target**: `test_instruction_encoding`
